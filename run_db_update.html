<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff00;
            text-align: center;
        }
        #console {
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            font-family: monospace;
        }
        button:hover {
            background: #00dd00;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .progress {
            width: 100%;
            height: 30px;
            background: #333;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: #00ff00;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }
        .error {
            color: #ff0000;
        }
        .success {
            color: #00ff00;
        }
        .info {
            color: #ffff00;
        }
    </style>
</head>
<body>
    <h1>üöÄ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• –¢–ê–†–ò–§–û–í</h1>
    
    <div id="controls">
        <button id="runBtn" onclick="runUpdate()">‚ñ∂ –ó–ê–ü–£–°–¢–ò–¢–¨ –û–ë–ù–û–í–õ–ï–ù–ò–ï</button>
    </div>

    <div class="progress">
        <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div id="console"></div>

    <script>
        const API_URL = "https://functions.poehali.dev/9a386a41-ad70-4d41-b906-6ba0b02f206c";
        const consoleEl = document.getElementById('console');
        const progressBar = document.getElementById('progressBar');
        const runBtn = document.getElementById('runBtn');

        const REGIONAL_TARIFFS = {
            '–ú–æ—Å–∫–≤–∞': 6.19, '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥': 5.70, '–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 6.35,
            '–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.85, '–ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.72, '–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.68,
            '–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.91, '–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.54, '–ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 6.12,
            '–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.48, '–ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.79, '–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.82,
            '–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.64, '–†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.76, '–°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.69,
            '–¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.73, '–¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.81, '–¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 6.08,
            '–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.84, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–µ–ª–∏—è': 6.15, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–æ–º–∏': 6.42,
            '–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 6.28, '–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û': 7.85, '–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.94,
            '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 6.23, '–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.82, '–ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 6.91,
            '–ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.77, '–ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.73, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–¥—ã–≥–µ—è': 5.34,
            '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞–ª–º—ã–∫–∏—è': 5.28, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö—Ä—ã–º': 5.67, '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π': 5.42,
            '–ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.39, '–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.48, '–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.51,
            '–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å': 5.63, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –î–∞–≥–µ—Å—Ç–∞–Ω': 4.89, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ò–Ω–≥—É—à–µ—Ç–∏—è': 4.76,
            '–ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞': 4.82, '–ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞': 4.79,
            '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è': 4.85, '–ß–µ—á–µ–Ω—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞': 4.73, '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π': 5.24,
            '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω': 5.18, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–∞—Ä–∏–π –≠–ª': 5.32, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–æ—Ä–¥–æ–≤–∏—è': 5.36,
            '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω': 5.12, '–£–¥–º—É—Ä—Ç—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞': 5.29, '–ß—É–≤–∞—à—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞': 5.34,
            '–ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.44, '–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.58, '–û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.22,
            '–ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.41, '–ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π': 5.37, '–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.46,
            '–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.39, '–£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.35, '–ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.28,
            '–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 4.98, '–¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.64, '–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û': 6.18,
            '–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û': 7.24, '–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.15, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–ª—Ç–∞–π': 4.52,
            '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢—ã–≤–∞': 4.38, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –•–∞–∫–∞—Å–∏—è': 3.82, '–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π': 4.67,
            '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π': 4.23, '–ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 3.21, '–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 4.44,
            '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 4.67, '–û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 4.89, '–¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 4.56,
            '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë—É—Ä—è—Ç–∏—è': 4.78, '–†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)': 7.92, '–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π': 5.87,
            '–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π': 8.45, '–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π': 6.34, '–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π': 6.28,
            '–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 5.92, '–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 8.12, '–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å': 7.38,
            '–ï–≤—Ä–µ–π—Å–∫–∞—è –ê–û': 5.84, '–ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û': 9.15
        };

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${time}] ${message}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function setProgress(percent) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }

        async function callApi(action, extraData = {}) {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...extraData })
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.statusText}`);
            }

            return response.json();
        }

        async function runUpdate() {
            runBtn.disabled = true;
            consoleEl.innerHTML = '';
            setProgress(0);

            try {
                log('='.repeat(80), 'success');
                log('–ù–ê–ß–ê–õ–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• –¢–ê–†–ò–§–û–í', 'success');
                log('='.repeat(80), 'success');

                log('\n–®–ê–ì 1/4: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö...', 'info');
                const deleteResult = await callApi('delete_all_prices');
                log(`‚úì –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${deleteResult.deleted_rows}`, 'success');
                setProgress(10);

                log('\n–®–ê–ì 2/4: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤...', 'info');
                const regionsResult = await callApi('get_all_regions');
                const regions = regionsResult.regions;
                log(`‚úì –ù–∞–π–¥–µ–Ω–æ —Ä–µ–≥–∏–æ–Ω–æ–≤: ${regions.length}`, 'success');
                setProgress(20);

                log('\n–®–ê–ì 3/4: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º...', 'info');
                const priceRecords = [];
                const dates = [
                    ['2024-01-01', 1.00],
                    ['2024-07-01', 1.023],
                    ['2024-12-01', 1.045]
                ];

                let moscowId = null;
                let spbId = null;

                for (const region of regions) {
                    const basePrice = REGIONAL_TARIFFS[region.name] || 5.50;

                    if (region.name === '–ú–æ—Å–∫–≤–∞') moscowId = region.id;
                    if (region.name === '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥') spbId = region.id;

                    for (const [dateStr, multiplier] of dates) {
                        priceRecords.push({
                            region_id: region.id,
                            price: Math.round(basePrice * multiplier * 100) / 100,
                            recorded_at: dateStr,
                            tariff_type: 'single',
                            consumer_type: 'standard',
                            time_zone: 'day',
                            source: 'official_2024'
                        });
                    }
                }

                if (moscowId) {
                    log('  ‚Üí –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ –¥–ª—è –ú–æ—Å–∫–≤—ã...', 'info');
                    const moscowTariffs = [
                        ['2024-01-01', 'two_zone', 'standard', 'day', 6.70],
                        ['2024-01-01', 'two_zone', 'standard', 'night', 2.19],
                        ['2024-01-01', 'three_zone', 'standard', 'peak', 7.32],
                        ['2024-01-01', 'three_zone', 'standard', 'half_peak', 5.92],
                        ['2024-01-01', 'three_zone', 'standard', 'night', 1.99],
                        ['2024-07-01', 'two_zone', 'standard', 'day', 6.85],
                        ['2024-07-01', 'two_zone', 'standard', 'night', 2.24],
                        ['2024-07-01', 'three_zone', 'standard', 'peak', 7.48],
                        ['2024-07-01', 'three_zone', 'standard', 'half_peak', 6.06],
                        ['2024-07-01', 'three_zone', 'standard', 'night', 2.03],
                        ['2024-12-01', 'two_zone', 'standard', 'day', 7.00],
                        ['2024-12-01', 'two_zone', 'standard', 'night', 2.29],
                        ['2024-12-01', 'three_zone', 'standard', 'peak', 7.65],
                        ['2024-12-01', 'three_zone', 'standard', 'half_peak', 6.19],
                        ['2024-12-01', 'three_zone', 'standard', 'night', 2.08],
                        ['2024-01-01', 'single', 'electric_stove', 'day', 4.14],
                        ['2024-01-01', 'two_zone', 'electric_stove', 'day', 4.69],
                        ['2024-01-01', 'two_zone', 'electric_stove', 'night', 1.53],
                        ['2024-07-01', 'single', 'electric_stove', 'day', 4.24],
                        ['2024-07-01', 'two_zone', 'electric_stove', 'day', 4.79],
                        ['2024-07-01', 'two_zone', 'electric_stove', 'night', 1.56],
                        ['2024-12-01', 'single', 'electric_stove', 'day', 4.33],
                        ['2024-12-01', 'two_zone', 'electric_stove', 'day', 4.90],
                        ['2024-12-01', 'two_zone', 'electric_stove', 'night', 1.60]
                    ];

                    for (const [date, tariff, consumer, zone, price] of moscowTariffs) {
                        priceRecords.push({
                            region_id: moscowId,
                            price: price,
                            recorded_at: date,
                            tariff_type: tariff,
                            consumer_type: consumer,
                            time_zone: zone,
                            source: 'official_2024_detailed'
                        });
                    }
                }

                if (spbId) {
                    log('  ‚Üí –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ –¥–ª—è –°–ü–±...', 'info');
                    priceRecords.push(
                        { region_id: spbId, price: 5.70, recorded_at: '2024-01-01', tariff_type: 'single', consumer_type: 'standard', time_zone: 'day', source: 'official_2024_detailed' },
                        { region_id: spbId, price: 6.19, recorded_at: '2024-07-01', tariff_type: 'single', consumer_type: 'standard', time_zone: 'day', source: 'official_2024_detailed' },
                        { region_id: spbId, price: 6.32, recorded_at: '2024-12-01', tariff_type: 'single', consumer_type: 'standard', time_zone: 'day', source: 'official_2024_detailed' }
                    );
                }

                log(`‚úì –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${priceRecords.length}`, 'success');
                setProgress(40);

                log('\n–®–ê–ì 4/4: –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑—É...', 'info');
                const BATCH_SIZE = 100;
                let totalInserted = 0;

                for (let i = 0; i < priceRecords.length; i += BATCH_SIZE) {
                    const batch = priceRecords.slice(i, i + BATCH_SIZE);
                    const result = await callApi('insert_prices', { prices: batch });
                    totalInserted += result.inserted_rows;
                    log(`  –ü–∞–∫–µ—Ç ${Math.floor(i / BATCH_SIZE) + 1}: –≤—Å—Ç–∞–≤–ª–µ–Ω–æ ${result.inserted_rows} –∑–∞–ø–∏—Å–µ–π`, 'info');
                    setProgress(40 + (i / priceRecords.length) * 50);
                }

                setProgress(100);
                log('\n' + '='.repeat(80), 'success');
                log('–û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!', 'success');
                log('='.repeat(80), 'success');
                log(`\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:`, 'success');
                log(`   ‚Ä¢ –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π: ${deleteResult.deleted_rows}`, 'info');
                log(`   ‚Ä¢ –†–µ–≥–∏–æ–Ω–æ–≤ –≤ –±–∞–∑–µ: ${regions.length}`, 'info');
                log(`   ‚Ä¢ –í—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π: ${totalInserted}`, 'info');
                log(`\n‚úÖ –¢–µ–ø–µ—Ä—å –≤ –±–∞–∑–µ —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã 2024 –≥–æ–¥–∞!`, 'success');

            } catch (error) {
                log(`\n‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                setProgress(0);
            } finally {
                runBtn.disabled = false;
            }
        }

        log('–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–ê–ü–£–°–¢–ò–¢–¨ –û–ë–ù–û–í–õ–ï–ù–ò–ï"', 'success');
    </script>
</body>
</html>
